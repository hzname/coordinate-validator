# Coordinate Validator - –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

## –ù–æ–≤–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è: –¢—Ä–∏–∞–Ω–≥—É–ª—è—Ü–∏—è

### –°—Ç–∞—Ä–∞—è –º–æ–¥–µ–ª—å (–≤–µ—Å–∞)
```
–ò—Ç–æ–≥ = WiFi*0.4 + Cell*0.3 + BLE*0.3
```
‚ùå –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏ –º–µ–∂–¥—É –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏

### –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å (–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ)
```
WiFi (BSSID) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ      ‚îå‚îÄ‚îÄ –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ #1
Cell Tower ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
                    ‚îÇ      ‚îî‚îÄ‚îÄ –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ #2
BLE Device ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è = —Ü–µ–Ω—Ç—Ä –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –≤—Å–µ—Ö –æ–±–ª–∞—Å—Ç–µ–π
```

---

## –ê–ª–≥–æ—Ä–∏—Ç–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏

### 1. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ ‚Äî —Ä–∞–¥–∏—É—Å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏

| –ò—Å—Ç–æ—á–Ω–∏–∫ | –¢–æ—á–Ω–æ—Å—Ç—å | –†–∞–¥–∏—É—Å |
|----------|---------|--------|
| GPS | 5-50–º | 50–º |
| Cell (MCC+MNC+LAC) | 300–º - 3–∫–º | 3000–º |
| Cell (—Å ATC) | 50-300–º | 300–º |
| WiFi (BSSID) | 20-50–º | 50–º |
| BLE (MAC) | 5-15–º | 15–º |

### 2. –ú–æ–¥–µ–ª—å –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è

```mermaid
flowchart TD
    Input[–ü–æ–ª—É—á–∏–ª –¥–∞–Ω–Ω—ã–µ<br/>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã + –∏—Å—Ç–æ—á–Ω–∏–∫–∏] --> Groups[–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–∏–ø—É]
    
    Groups --> WifiGroup[WiFi: BSSID1, BSSID2...]
    Groups --> CellGroup[Cell: CellID1, CellID2...]
    Groups --> BleGroup[BLE: MAC1, MAC2...]
    
    WifiGroup --> WifiCalc[–î–ª—è –∫–∞–∂–¥–æ–≥–æ BSSID:<br/>–ø–æ–ª—É—á–∏—Ç—å ABSOLUTE/CALCULATED]
    CellGroup --> CellCalc[–î–ª—è –∫–∞–∂–¥–æ–≥–æ Cell:<br/>–ø–æ–ª—É—á–∏—Ç—å ABSOLUTE/CALCULATED]
    BleGroup --> BleCalc[–î–ª—è –∫–∞–∂–¥–æ–≥–æ MAC:<br/>–ø–æ–ª—É—á–∏—Ç—å ABSOLUTE/CALCULATED]
    
    WifiCalc --> WifiArea[–û–±–ª–∞—Å—Ç—å #1:<br/>—Ç–æ—á–∫–∞ ¬± —Ä–∞–¥–∏—É—Å]
    CellCalc --> CellArea[–û–±–ª–∞—Å—Ç—å #2:<br/>—Ç–æ—á–∫–∞ ¬± —Ä–∞–¥–∏—É—Å]
    BleCalc --> BleArea[–û–±–ª–∞—Å—Ç—å #3:<br/>—Ç–æ—á–∫–∞ ¬± —Ä–∞–¥–∏—É—Å]
    
    WifiArea --> Intersect{–ï—Å—Ç—å<br/>–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ?}
    CellArea --> Intersect
    BleArea --> Intersect
    
    Intersect -->|–î–∞| Center[–¶–µ–Ω—Ç—Ä<br/>–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è]
    Intersect -->|–ù–µ—Ç| Weighted[–£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ<br/>–ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é]
    
    Center --> Result[–§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è]
    Weighted --> Result
```

### 3. –§–æ—Ä–º—É–ª–∞ —Ü–µ–Ω—Ç—Ä–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è

```
–î–ª—è 2 –∫—Ä—É–≥–æ–≤:
  d = —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ü–µ–Ω—Ç—Ä–∞–º–∏
  r1, r2 = —Ä–∞–¥–∏—É—Å—ã
  
  –ï—Å–ª–∏ d > r1 + r2: –Ω–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
  –ï—Å–ª–∏ d < |r1 - r2|: –æ–¥–∏–Ω –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–æ–≥–æ
  
  –ò–Ω–∞—á–µ:
    a = (r1¬≤ - r2¬≤ + d¬≤) / (2d)
    h = ‚àö(r1¬≤ - a¬≤)
    
    –¶–µ–Ω—Ç—Ä –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è:
      x = x1 + a*(x2-x1)/d ¬± h*(y2-y1)/d
      y = y1 + a*(y2-y1)/d ‚àì h*(x2-x1)/d
```

---

## –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

### 1. ABSOLUTE ‚Äî –ù–ï —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –æ–±—É—á–µ–Ω–∏–∏

```
ABSOLUTE ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ ABSOLUTE:
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
  - –ù–ï –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ CALCULATED
  - –ù–ï —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –æ–±—É—á–µ–Ω–∏–∏
```

### 2. CALCULATED ‚Äî –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∏–∑ –æ–±—É—á–µ–Ω–∏—è

```
–¢–æ–ª—å–∫–æ –∏–∑ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –ë–ï–ó ABSOLUTE
```

### 3. DEVIATION ‚Äî –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è

```
–ó–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è:
- –¢–æ–ª—å–∫–æ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ë–ï–ó ABSOLUTE
- –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–∞—á–µ—Å—Ç–≤–∞ CALCULATED
- –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è CALCULATED
```

---

## Flow –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π)

```mermaid
flowchart TD
    Start[–ü–æ–ª—É—á–∏–ª –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã] --> Filter[–§–∏–ª—å—Ç—Ä –º–æ–±–∏–ª—å–Ω—ã—Ö<br/>—É—Å—Ç—Ä–æ–π—Å—Ç–≤]
    
    Filter --> Groups{–ï—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏<br/>–±–µ–∑ ABSOLUTE?}
    
    Groups -->|–î–∞| Process[–û–±—Ä–∞–±–æ—Ç–∞—Ç—å]
    Groups -->|–ù–µ—Ç| UseAbsolute[–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å<br/>ABSOLUTE]
    
    Process --> GetSources[–ü–æ–ª—É—á–∏—Ç—å CALCULATED<br/>–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞]
    
    GetSources --> BuildAreas[–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –æ–±–ª–∞—Å—Ç–∏<br/>–Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏]
    
    BuildAreas --> FindIntersect{–ù–∞–π—Ç–∏<br/>–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ?}
    
    FindIntersect -->|–î–∞| CalcCenter[–¶–µ–Ω—Ç—Ä<br/>–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è]
    FindIntersect -->|–ù–µ—Ç| CalcWeighted[–£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ<br/>–ø–æ –≤–µ—Å–∞–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è]
    
    CalcCenter --> Validate[–í–∞–ª–∏–¥–∞—Ü–∏—è:<br/>—Å—Ä–∞–≤–Ω–∏—Ç—å —Å –≤—Ö–æ–¥—è—â–∏–º–∏]
    CalcWeighted --> Validate
    
    Validate --> CheckDeviation{–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ<br/>< –ø–æ—Ä–æ–≥?}
    
    CheckDeviation -->|–î–∞| Valid[VALID<br/>confidence = 1 - deviation/max]
    CheckDeviation -->|–ù–µ—Ç| Uncertain[UNCERTAIN<br/>–∑–∞–ø–∏—Å–∞—Ç—å DEVIATION]
    
    UseAbsolute --> FinalResult[VALID<br/>confidence = 1.0]
    
    Valid --> Save[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å: —Ç–æ–ª—å–∫–æ DEVIATION<br/>–ù–ï –æ–±—É—á–∞—Ç—å]
    Uncertain --> Save
    FinalResult --> End[–û—Ç–≤–µ—Ç]
    
    Save --> End
```

---

## –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –æ–±—É—á–µ–Ω–∏—è

### –ü—Ä–∏–Ω—Ü–∏–ø: –¢–æ–ª—å–∫–æ "—Å—ã—Ä—ã–µ" –¥–∞–Ω–Ω—ã–µ

```
–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
  - lat, lon, accuracy (–æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)
  - sources: WiFi[], Cell[], BLE[]

–î–ª—è –∫–∞–∂–¥–æ–≥–æ source (WiFi/BLE/Cell):
  1. –ï—Å—Ç—å ABSOLUTE –¥–ª—è —ç—Ç–æ–≥–æ source?
     ‚îÇ
     ‚îú‚îÄ –î–ê: –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å (–Ω–µ –æ–±—É—á–∞–µ–º)
     ‚îî‚îÄ –ù–ï–¢:
        ‚îú‚îÄ –ï—Å—Ç—å CALCULATED?
        ‚îÇ   ‚îú‚îÄ –î–ê: –ó–∞–ø–∏—Å–∞—Ç—å DEVIATION, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        ‚îÇ   ‚îî‚îÄ –ù–ï–¢: –°–æ–∑–¥–∞—Ç—å CALCULATED
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CALCULATED

```
DEVIATION_HISTORY = [d1, d2, d3, ... dn]  (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N)

avg_deviation = mean(DEVIATION_HISTORY)
max_deviation = max(DEVIATION_HISTORY)

–ï–°–õ–ò avg_deviation < THRESHOLD:
    CALCULATED = –æ–±–Ω–æ–≤–∏—Ç—å (—É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ)
–ò–ù–ê–ß–ï:
    CALCULATED = –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å
    (–∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ–Ω–∞–¥—ë–∂–µ–Ω)
```

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```yaml
positioning:
  # –†–∞–¥–∏—É—Å—ã –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
  radius:
    wifi: 50        # –º–µ—Ç—Ä–æ–≤
    ble: 15         # –º–µ—Ç—Ä–æ–≤  
    cell_lac: 3000  # –º–µ—Ç—Ä–æ–≤ (—Ç–æ–ª—å–∫–æ LAC)
    cell_atc: 300   # –º–µ—Ç—Ä–æ–≤ (—Å ATC)
  
  # –ú–∏–Ω–∏–º—É–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
  min_sources: 2
  
  # –ü–æ—Ä–æ–≥–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è CALCULATED
  learning:
    deviation_threshold: 50    # –º–µ—Ç—Ä–æ–≤
    min_observations: 3
    max_history: 10

# –§–∏–ª—å—Ç—Ä –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
filter:
  ble_exclude_oui:
    - "00:1E:7D"  # Apple
    - "3C:5A:B4"  # Google
    # ...
  wifi_exclude_patterns:
    - "iPhone*"
    - "Android*"
    - "Galaxy*"
```

---

## –ü—Ä–∏–º–µ—Ä—ã

### –ü—Ä–∏–º–µ—Ä 1: –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ WiFi + Cell

```
–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
  GPS: lat=55.7558, lon=37.6173
  WiFi BSSID1: AA:BB:CC:DD:EE:FF ‚Üí CALCULATED: 55.7555, 37.6170 (—Ä–∞–¥–∏—É—Å 50–º)
  Cell CID=12345, LAC=678 ‚Üí CALCULATED: 55.7560, 37.6180 (—Ä–∞–¥–∏—É—Å 300–º)

–û–±–ª–∞—Å—Ç–∏:
  - WiFi: –∫—Ä—É–≥ (55.7555, 37.6170, r=50–º)
  - Cell: –∫—Ä—É–≥ (55.7560, 37.6180, r=300–º)

–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ: –ï–°–¢–¨

–¶–µ–Ω—Ç—Ä –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è: 55.7557, 37.6172

–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å GPS:
  distance = 14–º
  deviation = 14–º < 50–º ‚Üí VALID
```

### –ü—Ä–∏–º–µ—Ä 2: –ù–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è

```
–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
  GPS: lat=55.7558, lon=37.6173
  WiFi BSSID1: ‚Üí CALCULATED: 55.7520, 37.6100 (—Ä–∞–¥–∏—É—Å 50–º) ‚Äî –¥–∞–ª–µ–∫–æ!
  Cell: ‚Üí CALCULATED: 55.7600, 37.6200 (—Ä–∞–¥–∏—É—Å 300–º)

–û–±–ª–∞—Å—Ç–∏ –ù–ï –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è (d > r1 + r2)

–†–µ—à–µ–Ω–∏–µ: –£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –¥–æ —Ü–µ–Ω—Ç—Ä–∞
  - –í–µ—Å WiFi: 1/50 = 0.02
  - –í–µ—Å Cell: 1/300 = 0.003
  
  –ò—Ç–æ–≥ = (WiFi * 0.02 + Cell * 0.003) / (0.02 + 0.003)
```

### –ü—Ä–∏–º–µ—Ä 3: ABSOLUTE ‚Äî –Ω–µ –æ–±—É—á–∞–µ–º

```
–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
  GPS: lat=55.7558, lon=37.6173
  WiFi BSSID1: ‚Üí ABSOLUTE: 55.7555, 37.6170 (–æ—Ç –Ω–∞–¥—ë–∂–Ω–æ–≥–æ API)

–î–ª—è —ç—Ç–æ–≥–æ WiFi:
  - ABSOLUTE –ï–°–¢–¨ ‚Üí –ü–†–û–ü–£–°–ö
  - –ù–ï —Å–æ–∑–¥–∞—ë–º CALCULATED
  - –ù–ï –∑–∞–ø–∏—Å—ã–≤–∞–µ–º DEVIATION
  
–ò—Å–ø–æ–ª—å–∑—É–µ–º ABSOLUTE –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
```

---

## API (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

```protobuf
service CoordinateValidator {
    rpc Validate(CoordinateRequest) returns (CoordinateResponse);
    rpc ValidateBatch(stream CoordinateRequest) returns (stream CoordinateResponse);
}

service AbsoluteCoordinates {
    rpc SetAbsoluteCoordinates(AbsoluteRequest) returns (AbsoluteResponse);
    rpc RemoveAbsoluteCoordinates(RemoveRequest) returns (RemoveResponse);
    rpc GetPointInfo(PointRequest) returns (PointInfoResponse);
}
```

---

## –†–µ–∑—é–º–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –°—Ç–∞—Ä–æ–µ | –ù–æ–≤–æ–µ |
|--------|-------|
| –í–µ—Å–∞: WiFi 0.4, Cell 0.3, BLE 0.3 | –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –æ–±–ª–∞—Å—Ç–µ–π |
| –í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –æ–±—É—á–µ–Ω–∏–∏ | ABSOLUTE ‚Äî –ù–ï —É—á–∞—Å—Ç–≤—É—é—Ç |
| CALCULATED –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞ | CALCULATED –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ avg_deviation < –ø–æ—Ä–æ–≥ |

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –§–∏–ª—å—Ç—Ä –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
2. ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏
3. ‚úÖ –¢—Ä–∏–∞–Ω–≥—É–ª—è—Ü–∏—è / –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ
4. ‚úÖ ABSOLUTE ‚Äî –Ω–µ –æ–±—É—á–∞–µ–º
5. ‚è≥ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞

–í—Å—ë —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç? –ù–∞—á–∏–Ω–∞–µ–º –∫–æ–¥–∏—Ç—å? üöï
